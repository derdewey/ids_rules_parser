#!/usr/bin/env ruby
$LOAD_PATH << ::File.expand_path(::File.dirname(__FILE__)) + "/../lib"
require 'rubygems'
require 'bundler'
require 'pp'
Bundler.require if File.exists?("./Gemfile")
require 'ids_rules_parser'
require 'json'

if ARGV.empty?
  puts "usage: #{__FILE__} file/to/parse.rules"
  exit(1)
end

# Parse each file
file_list = ARGV.collect {|x| Dir.glob(x)}
file_list.flatten!
file_list.uniq!
file_list.each do |filename|
	# Setup parser
	parser = IDSRulesParser.new
	parser.consume_all_input = true

	# Open input file
	puts filename
	file = File.open(filename, 'r')
		
	# Open output file
	File.open(filename+".json",'w') do |writer|
		begin
			client_friendly_data = {}
			while((contents = file.gets) != nil)
				# Process a line of input
				rule_data = parser.parse(contents).process
				
				# Output rule information to json file
				rule_data.each do |x|
					# Extract key
					gid = x[:signature]["gid"]
					if(gid.nil?) then
						gid = "1"
					end
					sid = x[:signature]["sid"]
					rev = x[:signature]["rev"]
					key = gid + "." + sid + "." + rev
					
					# Merge all data into a single hash
					client_friendly_data.merge!(key => x)
				end
			end
			# Conver to json and output to json file
			writer.puts (client_friendly_data.to_json)
		end
	end
end
exit(1)