#!/usr/bin/env ruby
$LOAD_PATH << ::File.expand_path(::File.dirname(__FILE__)) + "/../lib"
require 'rubygems'
require 'bundler'
require 'pp'
Bundler.require if File.exists?("./Gemfile")
require 'ids_rules_parser'

if ARGV.empty?
  puts "usage: #{__FILE__} file/to/parse.rules"
  exit(1)
end

parser = IDSRulesParser.new
parser.consume_all_input = true
filename = ARGV.first
file = File.read(filename)
parsed_data = parser.parse(file)
if(parsed_data.nil?)
  puts "Could not parse the rule file #{filename}"
  puts parser.failure_reason
  puts "Failure line: " + parser.failure_line.to_s
  puts "Failure column: " + parser.failure_column.to_s
else
  rule_data = parsed_data.process
  rule_data.each do |x|
    x[:signature].each do |y|
      print y.keys.first + ","
      if(!y.values.first.nil?)
        puts y.values.first
      else
        puts
      end
    end
  end
  puts filename + ": " + rule_data.length.to_s
  exit(1)
end



